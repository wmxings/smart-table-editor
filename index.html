<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Table Editor</title>
    <style>
        :root {
            --theme-color: #4a90e2;
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            gap: 20px;
        }
        .left-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .theme-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .theme-title {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .theme-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-circle.active {
            border-color: #000;
        }
        .button-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .button-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            text-align: left;
        }
        button:hover {
            background-color: #e0e0e0;
        }
        .table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td, th {
            padding: 4px 8px;
            border: 1px solid #ddd;
            min-width: 100px;
            height: 32px;
            line-height: 20px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            vertical-align: middle;
            white-space: pre-wrap;
            position: relative;
            box-sizing: border-box;
        }
        th {
            background-color: var(--theme-color);
            color: white;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: var(--theme-row-color, #e3f2fd);
        }
        tr:nth-child(odd) {
            background-color: white;
        }
        td:empty::before {
            content: '';
            display: inline-block;
            height: 20px;
            vertical-align: middle;
        }
        td:focus {
            outline: none;
            display: flex;
            align-items: center;
            min-height: 20px;
        }
        td[contenteditable="true"]:focus {
            outline: none;
        }
        td[contenteditable="true"]:not(.selected) {
            outline: none;
        }
        th[contenteditable="true"]:focus {
            outline: none;
        }
        th[contenteditable="true"]:not(.selected) {
            outline: none;
        }
        th.selected {
            outline: none !important;
        }
        td.selected {
            box-shadow: 0 0 0 2px var(--theme-color);
        }
        td[contenteditable="true"]:focus.selected {
            box-shadow: 0 0 0 2px var(--theme-color);
        }
        .load-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .load-section textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="theme-section">
            <div class="theme-colors">
                <div class="color-circle active" style="background-color: #4a90e2;" data-theme="blue"></div>
                <div class="color-circle" style="background-color: #00bcd4;" data-theme="cyan"></div>
                <div class="color-circle" style="background-color: #009688;" data-theme="teal"></div>
                <div class="color-circle" style="background-color: #50c878;" data-theme="green"></div>
                <div class="color-circle" style="background-color: #3f51b5;" data-theme="indigo"></div>
                <div class="color-circle" style="background-color: #673ab7;" data-theme="deepPurple"></div>
                <div class="color-circle" style="background-color: #9b59b6;" data-theme="purple"></div>
                <div class="color-circle" style="background-color: #e91e63;" data-theme="pink"></div>
                <div class="color-circle" style="background-color: #ff6b6b;" data-theme="red"></div>
                <div class="color-circle" style="background-color: #f39c12;" data-theme="orange"></div>
                <div class="color-circle" style="background-color: #795548;" data-theme="brown"></div>
                <div class="color-circle" style="background-color: #607d8b;" data-theme="gray"></div>
            </div>
        </div>
        <div class="button-section">
            <div class="button-grid">
                <button onclick="insertRow('up')">å‘ â¬†ï¸ æ’å…¥è¡Œ (Shift+â†‘)</button>
                <button onclick="insertRow('down')">å‘ â¬‡ï¸ æ’å…¥è¡Œ (Shift+â†“)</button>
                <button onclick="insertColumn('left')">å‘ â¬…ï¸ æ’å…¥åˆ— (Shift+â†)</button>
                <button onclick="insertColumn('right')">å‘ â¡ï¸ æ’å…¥åˆ— (Shift+â†’)</button>
                <button onclick="moveRow('up')">å‘ â¬†ï¸ ä¸Šç§»è¡Œ (Alt+â†‘)</button>
                <button onclick="moveRow('down')">å‘ â¬‡ï¸ ä¸‹ç§»è¡Œ (Alt+â†“)</button>
                <button onclick="moveColumn('left')">å‘ â¬…ï¸ å·¦ç§»åˆ— (Alt+â†)</button>
                <button onclick="moveColumn('right')">å‘ â¡ï¸ å³ç§»åˆ— (Alt+â†’)</button>
                <button onclick="deleteSelectedRows()">âŒï¸ åˆ é™¤è¡Œ (Shift+Delete)</button>
                <button onclick="deleteSelectedColumns()">âŒï¸ åˆ é™¤åˆ— (Delete)</button>
                <button onclick="undo()">â†©ï¸ æ’¤é”€ (Ctrl+Z)</button>
                <button onclick="redo()">â†ªï¸ é‡åš (Ctrl+Y)</button>
                <button onclick="saveTable()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
            </div>
        </div>
        <div class="load-section">
            <textarea id="tableContent" placeholder="åœ¨æ­¤ç²˜è´´table.txtçš„å†…å®¹..."></textarea>
            <button onclick="loadTableFromText()">ğŸ“‚ è½½å…¥è¡¨æ ¼</button>
        </div>
    </div>
    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th contenteditable="true">åˆ—1</th>
                    <th contenteditable="true">åˆ—2</th>
                    <th contenteditable="true">åˆ—3</th>
                    <th contenteditable="true">åˆ—4</th>
                    <th contenteditable="true">åˆ—5</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                </tr>
                <tr>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                </tr>
                <tr>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                </tr>
                <tr>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                    <td contenteditable="true"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let undoStack = [];
        let redoStack = [];
        let selectedCells = new Set();
        let isSelecting = false;
        let startCell = null;
        let currentTheme = 'blue';

        // åˆå§‹åŒ–ä¸»é¢˜
        updateTheme();

        // ä¸»é¢˜åˆ‡æ¢
        document.querySelectorAll('.color-circle').forEach(circle => {
            circle.addEventListener('click', () => {
                document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active'));
                circle.classList.add('active');
                currentTheme = circle.dataset.theme;
                updateTheme();
            });
        });

        // æ›´æ–°ä¸»é¢˜
        function updateTheme() {
            const colors = {
                blue: { header: '#4a90e2', row: '#e3f2fd' },
                cyan: { header: '#00bcd4', row: '#e0f7fa' },
                teal: { header: '#009688', row: '#e0f2f1' },
                green: { header: '#50c878', row: '#e8f5e9' },
                indigo: { header: '#3f51b5', row: '#e8eaf6' },
                deepPurple: { header: '#673ab7', row: '#ede7f6' },
                purple: { header: '#9b59b6', row: '#f3e5f5' },
                pink: { header: '#e91e63', row: '#fce4ec' },
                red: { header: '#ff6b6b', row: '#ffebee' },
                orange: { header: '#f39c12', row: '#fff3e0' },
                brown: { header: '#795548', row: '#efebe9' },
                gray: { header: '#607d8b', row: '#eceff1' }
            };

            // ä¿å­˜å½“å‰é€‰ä¸­çš„å•å…ƒæ ¼
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });

            document.documentElement.style.setProperty('--theme-color', colors[currentTheme].header);
            document.documentElement.style.setProperty('--theme-row-color', colors[currentTheme].row);

            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                row.style.backgroundColor = i % 2 === 0 ? 'white' : colors[currentTheme].row;
            }

            // æ¢å¤é€‰ä¸­çš„å•å…ƒæ ¼
            selectedCells.clear();
            selectedCellIndices.forEach(({ rowIndex, colIndex }) => {
                const row = rows[rowIndex - 1]; // å‡å»1æ¥è°ƒæ•´è¡¨å¤´çš„å½±å“
                if (row && row.children[colIndex]) {
                    const cell = row.children[colIndex];
                    cell.classList.add('selected');
                    selectedCells.add(cell);
                }
            });
        }

        // å•å…ƒæ ¼é€‰æ‹©
        document.querySelectorAll('td, th').forEach(cell => {
            cell.addEventListener('mousedown', (e) => {
                isSelecting = true;
                startCell = cell;
                // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCells.clear();
                if (cell.tagName === 'TD') {
                    cell.classList.add('selected');
                    cell.focus();
                }
                selectedCells.add(cell);
            });

            cell.addEventListener('mouseover', (e) => {
                if (isSelecting && startCell) {
                    const table = document.getElementById('mainTable');
                    const rows = table.getElementsByTagName('tr');
                    const startRow = startCell.parentElement.rowIndex;
                    const startCol = Array.from(startCell.parentElement.children).indexOf(startCell);
                    const currentRow = cell.parentElement.rowIndex;
                    const currentCol = Array.from(cell.parentElement.children).indexOf(cell);

                    const minRow = Math.min(startRow, currentRow);
                    const maxRow = Math.max(startRow, currentRow);
                    const minCol = Math.min(startCol, currentCol);
                    const maxCol = Math.max(startCol, currentCol);

                    // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                    selectedCells.clear();
                    for (let i = minRow; i <= maxRow; i++) {
                        for (let j = minCol; j <= maxCol; j++) {
                            const selectedCell = rows[i].children[j];
                            if (selectedCell.tagName === 'TD') {
                                selectedCell.classList.add('selected');
                                if (i === currentRow && j === currentCol) {
                                    selectedCell.focus();
                                }
                            }
                            selectedCells.add(selectedCell);
                        }
                    }
                }
            });

            // æ·»åŠ å¤±å»ç„¦ç‚¹äº‹ä»¶ç›‘å¬
            cell.addEventListener('blur', (e) => {
                if (!selectedCells.has(cell)) {
                    cell.classList.remove('selected');
                }
            });
        });

        document.addEventListener('mouseup', () => {
            isSelecting = false;
            startCell = null;
        });

        // ä¿å­˜è¡¨æ ¼çŠ¶æ€
        function saveTableState() {
            const table = document.getElementById('mainTable');
            undoStack.push(table.innerHTML);
            redoStack = [];
        }

        // æ’¤é”€
        function undo() {
            if (undoStack.length > 0) {
                const table = document.getElementById('mainTable');
                redoStack.push(table.innerHTML);
                table.innerHTML = undoStack.pop();
                updateTableListeners();
                updateTheme();
            }
        }

        // è¿˜åŸ
        function redo() {
            if (redoStack.length > 0) {
                const table = document.getElementById('mainTable');
                undoStack.push(table.innerHTML);
                table.innerHTML = redoStack.pop();
                updateTableListeners();
                updateTheme();
            }
        }

        // æ›´æ–°è¡¨æ ¼ç›‘å¬å™¨
        function updateTableListeners() {
            document.querySelectorAll('td, th').forEach(cell => {
                cell.addEventListener('mousedown', (e) => {
                    isSelecting = true;
                    startCell = cell;
                    // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                    selectedCells.clear();
                    if (cell.tagName === 'TD') {
                        cell.classList.add('selected');
                        cell.focus();
                    }
                    selectedCells.add(cell);
                });

                cell.addEventListener('mouseover', (e) => {
                    if (isSelecting && startCell) {
                        const table = document.getElementById('mainTable');
                        const rows = table.getElementsByTagName('tr');
                        const startRow = startCell.parentElement.rowIndex;
                        const startCol = Array.from(startCell.parentElement.children).indexOf(startCell);
                        const currentRow = cell.parentElement.rowIndex;
                        const currentCol = Array.from(cell.parentElement.children).indexOf(cell);

                        const minRow = Math.min(startRow, currentRow);
                        const maxRow = Math.max(startRow, currentRow);
                        const minCol = Math.min(startCol, currentCol);
                        const maxCol = Math.max(startCol, currentCol);

                        // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                        selectedCells.clear();
                        for (let i = minRow; i <= maxRow; i++) {
                            for (let j = minCol; j <= maxCol; j++) {
                                const selectedCell = rows[i].children[j];
                                if (selectedCell.tagName === 'TD') {
                                    selectedCell.classList.add('selected');
                                    if (i === currentRow && j === currentCol) {
                                        selectedCell.focus();
                                    }
                                }
                                selectedCells.add(selectedCell);
                            }
                        }
                    }
                });

                // æ·»åŠ å¤±å»ç„¦ç‚¹äº‹ä»¶ç›‘å¬
                cell.addEventListener('blur', (e) => {
                    if (!selectedCells.has(cell)) {
                        cell.classList.remove('selected');
                    }
                });
            });
        }

        // æ’å…¥è¡Œ
        function insertRow(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å•å…ƒæ ¼ä½ç½®
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });

            // è·å–é€‰ä¸­çš„è¡Œç´¢å¼•ï¼ˆéœ€è¦å‡å»1æ¥è°ƒæ•´è¡¨å¤´çš„å½±å“ï¼‰
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    selectedRows.add(cell.parentElement.rowIndex - 1);
                }
            });

            if (selectedRows.size === 0) return;

            const newRow = document.createElement('tr');
            const colCount = rows[0].children.length;
            
            for (let i = 0; i < colCount; i++) {
                const td = document.createElement('td');
                td.contentEditable = true;
                newRow.appendChild(td);
            }

            // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();

            if (direction === 'up') {
                const minRow = Math.min(...selectedRows);
                tbody.insertBefore(newRow, tbody.children[minRow]);
            } else {
                const maxRow = Math.max(...selectedRows);
                tbody.insertBefore(newRow, tbody.children[maxRow + 1]);
            }

            // å°†ç„¦ç‚¹ç§»åŠ¨åˆ°æ–°æ’å…¥è¡Œçš„å¯¹åº”åˆ—ä½ç½®
            if (selectedCellIndices.length > 0) {
                const { colIndex } = selectedCellIndices[0];
                const targetCell = newRow.children[colIndex];
                if (targetCell) {
                    targetCell.classList.add('selected');
                    selectedCells.add(targetCell);
                    targetCell.focus();
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // æ’å…¥åˆ—
        function insertColumn(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å•å…ƒæ ¼ä½ç½®
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });
            
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            const colCount = rows[0].children.length;
            const newColIndex = direction === 'left' ? Math.min(...selectedCols) : Math.max(...selectedCols) + 1;

            // æ¸…é™¤æ‰€æœ‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();

            // æ’å…¥è¡¨å¤´
            const newHeader = document.createElement('th');
            newHeader.contentEditable = true;
            newHeader.textContent = `åˆ—${colCount + 1}`;
            rows[0].insertBefore(newHeader, rows[0].children[newColIndex]);

            // æ’å…¥æ•°æ®å•å…ƒæ ¼
            for (let i = 1; i < rows.length; i++) {
                const newCell = document.createElement('td');
                newCell.contentEditable = true;
                rows[i].insertBefore(newCell, rows[i].children[newColIndex]);
            }

            // å°†ç„¦ç‚¹ç§»åŠ¨åˆ°æ–°æ’å…¥åˆ—çš„å¯¹åº”è¡Œä½ç½®
            if (selectedCellIndices.length > 0) {
                const { rowIndex } = selectedCellIndices[0];
                const targetCell = rows[rowIndex].children[newColIndex];
                if (targetCell) {
                    targetCell.classList.add('selected');
                    selectedCells.add(targetCell);
                    targetCell.focus();
                }
            }

            // æ›´æ–°è¡¨æ ¼ç›‘å¬å™¨å’Œä¸»é¢˜
            updateTableListeners();
            updateTheme();

            // ç¡®ä¿æ‰€æœ‰å•å…ƒæ ¼çš„è¾¹æ¡†çŠ¶æ€æ­£ç¡®
            document.querySelectorAll('td, th').forEach(cell => {
                if (!selectedCells.has(cell)) {
                    cell.classList.remove('selected');
                }
            });
        }

        // åˆ é™¤é€‰ä¸­çš„è¡Œ
        function deleteSelectedRows() {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    const row = cell.parentElement;
                    selectedRows.add(row);
                }
            });

            const rowsToDelete = Array.from(selectedRows);
            rowsToDelete.forEach(row => {
                tbody.removeChild(row);
            });

            updateTableListeners();
            updateTheme();
        }

        // åˆ é™¤é€‰ä¸­çš„åˆ—
        function deleteSelectedColumns() {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            const colsToDelete = Array.from(selectedCols).sort((a, b) => b - a);
            colsToDelete.forEach(colIndex => {
                for (let i = 0; i < rows.length; i++) {
                    rows[i].removeChild(rows[i].children[colIndex]);
                }
            });

            updateTableListeners();
            updateTheme();
        }

        // ä¿å­˜è¡¨æ ¼
        function saveTable() {
            const table = document.getElementById('mainTable');
            const tableHtml = table.outerHTML.replace(/\s+/g, ' ').trim();
            
            // ä¿å­˜åˆ°table.txt
            const blob = new Blob([tableHtml], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ä»æ–‡æœ¬è½½å…¥è¡¨æ ¼
        function loadTableFromText() {
            const content = document.getElementById('tableContent').value;
            if (!content) return;

            const table = document.getElementById('mainTable');
            table.innerHTML = content;
            updateTableListeners();
            updateTheme();
        }

        // ç§»åŠ¨è¡Œ
        function moveRow(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            // è·å–é€‰ä¸­çš„è¡Œ
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    selectedRows.add(cell.parentElement);
                }
            });

            if (selectedRows.size === 0) return;

            const rowsToMove = Array.from(selectedRows);
            if (direction === 'up') {
                // ä»ä¸‹å¾€ä¸Šç§»åŠ¨ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                for (let i = 0; i < rowsToMove.length; i++) {
                    const row = rowsToMove[i];
                    const prevRow = row.previousElementSibling;
                    if (prevRow && prevRow.tagName === 'TR') {
                        tbody.insertBefore(row, prevRow);
                    }
                }
            } else {
                // ä»ä¸Šå¾€ä¸‹ç§»åŠ¨ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                for (let i = rowsToMove.length - 1; i >= 0; i--) {
                    const row = rowsToMove[i];
                    const nextRow = row.nextElementSibling;
                    if (nextRow && nextRow.tagName === 'TR') {
                        tbody.insertBefore(row, nextRow.nextElementSibling);
                    }
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // ç§»åŠ¨åˆ—
        function moveColumn(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            // è·å–é€‰ä¸­çš„åˆ—ç´¢å¼•
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            if (selectedCols.size === 0) return;

            const colsToMove = Array.from(selectedCols);
            if (direction === 'left') {
                // ä»å³å¾€å·¦ç§»åŠ¨ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                for (let i = 0; i < colsToMove.length; i++) {
                    const colIndex = colsToMove[i];
                    if (colIndex > 0) {
                        for (let row of rows) {
                            const cell = row.children[colIndex];
                            row.insertBefore(cell, row.children[colIndex - 1]);
                        }
                    }
                }
            } else {
                // ä»å·¦å¾€å³ç§»åŠ¨ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                for (let i = colsToMove.length - 1; i >= 0; i--) {
                    const colIndex = colsToMove[i];
                    if (colIndex < rows[0].children.length - 1) {
                        for (let row of rows) {
                            const cell = row.children[colIndex];
                            row.insertBefore(cell, row.children[colIndex + 2]);
                        }
                    }
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', (e) => {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å•å…ƒæ ¼
            if (selectedCells.size === 0) return;

            // åˆ é™¤è¡Œ/åˆ—çš„å¿«æ·é”®ï¼ˆç§»åˆ°æœ€å‰é¢ï¼‰
            if (e.key === 'Delete') {
                e.preventDefault();
                if (e.shiftKey) {
                    deleteSelectedRows();
                } else {
                    deleteSelectedColumns();
                }
                return;
            }

            // å–æ¶ˆç¼–è¾‘çš„å¿«æ·é”®
            if (e.key === 'Escape') {
                e.preventDefault();
                // ç§»é™¤ç¼–è¾‘çŠ¶æ€ä½†ä¿ç•™ç„¦ç‚¹å’Œé€‰ä¸­çŠ¶æ€
                const activeElement = document.activeElement;
                if (activeElement && activeElement.matches('td, th')) {
                    // ä¿å­˜å½“å‰å†…å®¹
                    const content = activeElement.innerHTML;
                    // ç§»é™¤ contenteditable å±æ€§
                    activeElement.removeAttribute('contenteditable');
                    // é‡æ–°è®¾ç½®å†…å®¹
                    activeElement.innerHTML = content;
                    // é‡æ–°æ·»åŠ  contenteditable å±æ€§
                    activeElement.setAttribute('contenteditable', 'true');
                    // ç§»é™¤ç„¦ç‚¹
                    activeElement.blur();
                    // é‡æ–°è·å¾—ç„¦ç‚¹
                    setTimeout(() => {
                        activeElement.focus();
                        // å°†å…‰æ ‡ç§»åŠ¨åˆ°å†…å®¹æœ«å°¾
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(activeElement);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }, 0);
                }
                return;
            }

            // æ–¹å‘é”®ç§»åŠ¨å•å…ƒæ ¼
            if (!e.ctrlKey && !e.altKey) {
                switch (e.key) {
                    case 'ArrowUp':
                    case 'ArrowDown':
                    case 'ArrowLeft':
                    case 'ArrowRight':
                        if (!e.shiftKey) {
                            e.preventDefault();
                            moveCellFocus(e.key);
                            return;
                        }
                        break;
                    case 'Tab':
                        e.preventDefault();
                        // å¦‚æœæŒ‰ä½ Shiftï¼Œåˆ™å‘å·¦ç§»åŠ¨ï¼Œå¦åˆ™å‘å³ç§»åŠ¨
                        const direction = e.shiftKey ? 'ArrowLeft' : 'ArrowRight';
                        const currentCell = document.activeElement;
                        if (!currentCell || !currentCell.matches('td, th')) return;

                        const currentRow = currentCell.parentElement;
                        const currentRowIndex = currentRow.rowIndex;
                        const currentColIndex = Array.from(currentRow.children).indexOf(currentCell);
                        const table = document.getElementById('mainTable');
                        const rows = table.getElementsByTagName('tr');
                        
                        if (e.shiftKey && currentColIndex === 0) {
                            // å¦‚æœæ˜¯ç¬¬ä¸€åˆ—ï¼Œè·³è½¬åˆ°ä¸Šä¸€è¡Œçš„æœ€åä¸€åˆ—
                            if (currentRowIndex > 0) {
                                const prevRow = rows[currentRowIndex - 1];
                                const lastCell = prevRow.children[prevRow.children.length - 1];
                                selectAndFocusCell(lastCell);
                            }
                        } else if (!e.shiftKey && currentColIndex === currentRow.children.length - 1) {
                            // å¦‚æœæ˜¯æœ€åä¸€åˆ—ï¼Œè·³è½¬åˆ°ä¸‹ä¸€è¡Œçš„ç¬¬ä¸€åˆ—
                            if (currentRowIndex < rows.length - 1) {
                                const nextRow = rows[currentRowIndex + 1];
                                const firstCell = nextRow.children[0];
                                selectAndFocusCell(firstCell);
                            }
                        } else {
                            // æ­£å¸¸ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª/ä¸Šä¸€ä¸ªå•å…ƒæ ¼
                            moveCellFocus(direction);
                        }
                        return;
                }
            }

            // æ’å…¥è¡Œ/åˆ—çš„å¿«æ·é”®
            if (e.shiftKey) {
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        insertRow('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        insertRow('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        insertColumn('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        insertColumn('right');
                        break;
                }
            }
            // ç§»åŠ¨è¡Œ/åˆ—çš„å¿«æ·é”®
            else if (e.altKey) {
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        moveRow('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        moveRow('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        moveColumn('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        moveColumn('right');
                        break;
                }
            }
            // æ’¤é”€ã€è¿˜åŸã€ä¿å­˜çš„å¿«æ·é”®
            else if (e.ctrlKey) {
                switch (e.key.toLowerCase()) {
                    case 'z':
                        if (!e.shiftKey) {
                            e.preventDefault();
                            undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 's':
                        e.preventDefault();
                        saveTable();
                        break;
                }
            }
        });

        // ç§»åŠ¨å•å…ƒæ ¼ç„¦ç‚¹
        function moveCellFocus(direction) {
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            const currentCell = document.activeElement;
            
            if (!currentCell || !currentCell.matches('td, th')) return;

            const currentRow = currentCell.parentElement;
            const currentRowIndex = currentRow.rowIndex;
            const currentColIndex = Array.from(currentRow.children).indexOf(currentCell);
            
            let targetRow, targetCol;
            
            switch (direction) {
                case 'ArrowUp':
                    targetRow = rows[currentRowIndex - 1];
                    targetCol = currentColIndex;
                    break;
                case 'ArrowDown':
                    targetRow = rows[currentRowIndex + 1];
                    targetCol = currentColIndex;
                    break;
                case 'ArrowLeft':
                    targetRow = currentRow;
                    targetCol = currentColIndex - 1;
                    break;
                case 'ArrowRight':
                    targetRow = currentRow;
                    targetCol = currentColIndex + 1;
                    break;
            }

            if (targetRow && targetRow.children[targetCol]) {
                const targetCell = targetRow.children[targetCol];
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCells.clear();
                // é€‰ä¸­å¹¶èšç„¦ç›®æ ‡å•å…ƒæ ¼
                targetCell.classList.add('selected');
                selectedCells.add(targetCell);
                targetCell.focus();
            }
        }

        // é€‰ä¸­å¹¶èšç„¦å•å…ƒæ ¼çš„è¾…åŠ©å‡½æ•°
        function selectAndFocusCell(cell) {
            // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();
            // é€‰ä¸­å¹¶èšç„¦ç›®æ ‡å•å…ƒæ ¼
            cell.classList.add('selected');
            selectedCells.add(cell);
            cell.focus();
        }

        // åˆå§‹åŒ–è¡¨æ ¼ç›‘å¬å™¨
        updateTableListeners();
    </script>
</body>
</html> 