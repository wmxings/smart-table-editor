<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Table Editor</title>
    <style>
        :root {
            --theme-color: #4a90e2;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            gap: 20px;
            min-height: 100vh;
        }
        .left-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        .theme-section {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .theme-title {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .theme-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-circle.active {
            border-color: #000;
        }
        .button-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .button-grid button {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: left;
            width: 100%;
        }
        .button-grid button:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .button-grid button:active {
            transform: translateY(0);
        }
        .button-grid button .shortcut {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: all 0.2s ease;
        }
        .button-grid button:hover .shortcut {
            display: inline-block;
            opacity: 1;
        }
        .button-grid button .shortcut::before {
            content: '‚å®';
            margin-right: 4px;
            font-size: 0.9em;
        }
        .table-section {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 0;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: white;
        }
        th {
            background-color: var(--theme-color);
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        td, th {
            padding: 4px 8px;
            border: 1px solid #ddd;
            min-width: 100px;
            height: 32px;
            line-height: 20px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            vertical-align: middle;
            white-space: pre-wrap;
            position: relative;
            box-sizing: border-box;
        }
        tr:nth-child(even) {
            background-color: var(--theme-row-color, #e3f2fd);
        }
        tr:nth-child(odd) {
            background-color: white;
        }
        td:empty::before {
            content: '';
            display: inline-block;
            height: 20px;
            vertical-align: middle;
        }
        td:focus {
            outline: none;
            display: flex;
            align-items: center;
            min-height: 20px;
        }
        td[contenteditable="true"]:focus {
            outline: none;
        }
        td[contenteditable="true"]:not(.selected) {
            outline: none;
        }
        th[contenteditable="true"]:focus {
            outline: none;
        }
        th[contenteditable="true"]:not(.selected) {
            outline: none;
        }
        th.selected {
            outline: none !important;
        }
        td.selected {
            box-shadow: 0 0 0 2px var(--theme-color);
        }
        td[contenteditable="true"]:focus.selected {
            box-shadow: 0 0 0 2px var(--theme-color);
        }
        .load-section {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .load-section textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            box-sizing: border-box;
            max-width: 280px;
        }
        .load-section button {
            width: 100%;
            max-width: 280px;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="theme-section">
            <div class="theme-colors">
                <div class="color-circle active" style="background-color: #4a90e2;" data-theme="blue"></div>
                <div class="color-circle" style="background-color: #00bcd4;" data-theme="cyan"></div>
                <div class="color-circle" style="background-color: #009688;" data-theme="teal"></div>
                <div class="color-circle" style="background-color: #50c878;" data-theme="green"></div>
                <div class="color-circle" style="background-color: #3f51b5;" data-theme="indigo"></div>
                <div class="color-circle" style="background-color: #673ab7;" data-theme="deepPurple"></div>
                <div class="color-circle" style="background-color: #9b59b6;" data-theme="purple"></div>
                <div class="color-circle" style="background-color: #e91e63;" data-theme="pink"></div>
                <div class="color-circle" style="background-color: #ff6b6b;" data-theme="red"></div>
                <div class="color-circle" style="background-color: #f39c12;" data-theme="orange"></div>
                <div class="color-circle" style="background-color: #795548;" data-theme="brown"></div>
                <div class="color-circle" style="background-color: #607d8b;" data-theme="gray"></div>
            </div>
        </div>
        <div class="button-section">
            <div class="button-grid">
                <button onclick="insertRow('up')">Âêë ‚¨ÜÔ∏è ÊèíÂÖ•Ë°å<span class="shortcut">Shift+‚Üë</span></button>
                <button onclick="insertRow('down')">Âêë ‚¨áÔ∏è ÊèíÂÖ•Ë°å<span class="shortcut">Shift+‚Üì</span></button>
                <button onclick="insertColumn('left')">Âêë ‚¨ÖÔ∏è ÊèíÂÖ•Âàó<span class="shortcut">Shift+‚Üê</span></button>
                <button onclick="insertColumn('right')">Âêë ‚û°Ô∏è ÊèíÂÖ•Âàó<span class="shortcut">Shift+‚Üí</span></button>
                <button onclick="moveRow('up')">Âêë ‚¨ÜÔ∏è ‰∏äÁßªË°å<span class="shortcut">Alt+‚Üë</span></button>
                <button onclick="moveRow('down')">Âêë ‚¨áÔ∏è ‰∏ãÁßªË°å<span class="shortcut">Alt+‚Üì</span></button>
                <button onclick="moveColumn('left')">Âêë ‚¨ÖÔ∏è Â∑¶ÁßªÂàó<span class="shortcut">Alt+‚Üê</span></button>
                <button onclick="moveColumn('right')">Âêë ‚û°Ô∏è Âè≥ÁßªÂàó<span class="shortcut">Alt+‚Üí</span></button>
                <button onclick="deleteSelectedRows()">‚ùåÔ∏è Âà†Èô§Ë°å<span class="shortcut">Shift+Delete</span></button>
                <button onclick="deleteSelectedColumns()">‚ùåÔ∏è Âà†Èô§Âàó<span class="shortcut">Delete</span></button>
                <button onclick="undo()">‚Ü©Ô∏è Êí§ÈîÄ<span class="shortcut">Ctrl+Z</span></button>
                <button onclick="redo()">‚Ü™Ô∏è ÈáçÂÅö<span class="shortcut">Ctrl+Y</span></button>
                <button onclick="saveTable()">üíæ ‰øùÂ≠ò<span class="shortcut">Ctrl+S</span></button>
            </div>
        </div>
        <div class="load-section">
            <textarea id="tableContent" placeholder="Âú®Ê≠§Á≤òË¥¥table.txtÁöÑÂÜÖÂÆπ..."></textarea>
            <button onclick="loadTableFromText()">üìÇ ËΩΩÂÖ•Ë°®Ê†º</button>
        </div>
    </div>
    <div class="table-section">
        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th contenteditable="true">Âàó1</th>
                        <th contenteditable="true">Âàó2</th>
                        <th contenteditable="true">Âàó3</th>
                        <th contenteditable="true">Âàó4</th>
                        <th contenteditable="true">Âàó5</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                    <tr>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let undoStack = [];
        let redoStack = [];
        let selectedCells = new Set();
        let isSelecting = false;
        let startCell = null;
        let currentTheme = 'blue';

        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        updateTheme();

        // ‰∏ªÈ¢òÂàáÊç¢
        document.querySelectorAll('.color-circle').forEach(circle => {
            circle.addEventListener('click', () => {
                document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active'));
                circle.classList.add('active');
                currentTheme = circle.dataset.theme;
                updateTheme();
            });
        });

        // Êõ¥Êñ∞‰∏ªÈ¢ò
        function updateTheme() {
            const colors = {
                blue: { header: '#4a90e2', row: '#e3f2fd' },
                cyan: { header: '#00bcd4', row: '#e0f7fa' },
                teal: { header: '#009688', row: '#e0f2f1' },
                green: { header: '#50c878', row: '#e8f5e9' },
                indigo: { header: '#3f51b5', row: '#e8eaf6' },
                deepPurple: { header: '#673ab7', row: '#ede7f6' },
                purple: { header: '#9b59b6', row: '#f3e5f5' },
                pink: { header: '#e91e63', row: '#fce4ec' },
                red: { header: '#ff6b6b', row: '#ffebee' },
                orange: { header: '#f39c12', row: '#fff3e0' },
                brown: { header: '#795548', row: '#efebe9' },
                gray: { header: '#607d8b', row: '#eceff1' }
            };

            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });

            document.documentElement.style.setProperty('--theme-color', colors[currentTheme].header);
            document.documentElement.style.setProperty('--theme-row-color', colors[currentTheme].row);

            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                row.style.backgroundColor = i % 2 === 0 ? 'white' : colors[currentTheme].row;
            }

            // ÊÅ¢Â§çÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
            selectedCells.clear();
            selectedCellIndices.forEach(({ rowIndex, colIndex }) => {
                const row = rows[rowIndex - 1]; // ÂáèÂéª1Êù•Ë∞ÉÊï¥Ë°®Â§¥ÁöÑÂΩ±Âìç
                if (row && row.children[colIndex]) {
                    const cell = row.children[colIndex];
                    cell.classList.add('selected');
                    selectedCells.add(cell);
                }
            });
        }

        // ÂçïÂÖÉÊ†ºÈÄâÊã©
        document.querySelectorAll('td, th').forEach(cell => {
            cell.addEventListener('mousedown', (e) => {
                isSelecting = true;
                startCell = cell;
                // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCells.clear();
                if (cell.tagName === 'TD') {
                    cell.classList.add('selected');
                    cell.focus();
                }
                selectedCells.add(cell);
            });

            cell.addEventListener('mouseover', (e) => {
                if (isSelecting && startCell) {
                    const table = document.getElementById('mainTable');
                    const rows = table.getElementsByTagName('tr');
                    const startRow = startCell.parentElement.rowIndex;
                    const startCol = Array.from(startCell.parentElement.children).indexOf(startCell);
                    const currentRow = cell.parentElement.rowIndex;
                    const currentCol = Array.from(cell.parentElement.children).indexOf(cell);

                    const minRow = Math.min(startRow, currentRow);
                    const maxRow = Math.max(startRow, currentRow);
                    const minCol = Math.min(startCol, currentCol);
                    const maxCol = Math.max(startCol, currentCol);

                    // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                    document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                    selectedCells.clear();
                    for (let i = minRow; i <= maxRow; i++) {
                        for (let j = minCol; j <= maxCol; j++) {
                            const selectedCell = rows[i].children[j];
                            if (selectedCell.tagName === 'TD') {
                                selectedCell.classList.add('selected');
                                if (i === currentRow && j === currentCol) {
                                    selectedCell.focus();
                                }
                            }
                            selectedCells.add(selectedCell);
                        }
                    }
                }
            });

            // Ê∑ªÂä†Â§±ÂéªÁÑ¶ÁÇπ‰∫ã‰ª∂ÁõëÂê¨
            cell.addEventListener('blur', (e) => {
                if (!selectedCells.has(cell)) {
                    cell.classList.remove('selected');
                }
            });
        });

        document.addEventListener('mouseup', () => {
            isSelecting = false;
            startCell = null;
        });

        // ‰øùÂ≠òË°®Ê†ºÁä∂ÊÄÅ
        function saveTableState() {
            const table = document.getElementById('mainTable');
            undoStack.push(table.innerHTML);
            redoStack = [];
        }

        // Êí§ÈîÄ
        function undo() {
            if (undoStack.length > 0) {
                const table = document.getElementById('mainTable');
                redoStack.push(table.innerHTML);
                table.innerHTML = undoStack.pop();
                updateTableListeners();
                updateTheme();
            }
        }

        // ËøòÂéü
        function redo() {
            if (redoStack.length > 0) {
                const table = document.getElementById('mainTable');
                undoStack.push(table.innerHTML);
                table.innerHTML = redoStack.pop();
                updateTableListeners();
                updateTheme();
            }
        }

        // Êõ¥Êñ∞Ë°®Ê†ºÁõëÂê¨Âô®
        function updateTableListeners() {
            document.querySelectorAll('td, th').forEach(cell => {
                cell.addEventListener('mousedown', (e) => {
                    isSelecting = true;
                    startCell = cell;
                    // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                    document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                    selectedCells.clear();
                    if (cell.tagName === 'TD') {
                        cell.classList.add('selected');
                        cell.focus();
                    }
                    selectedCells.add(cell);
                });

                cell.addEventListener('mouseover', (e) => {
                    if (isSelecting && startCell) {
                        const table = document.getElementById('mainTable');
                        const rows = table.getElementsByTagName('tr');
                        const startRow = startCell.parentElement.rowIndex;
                        const startCol = Array.from(startCell.parentElement.children).indexOf(startCell);
                        const currentRow = cell.parentElement.rowIndex;
                        const currentCol = Array.from(cell.parentElement.children).indexOf(cell);

                        const minRow = Math.min(startRow, currentRow);
                        const maxRow = Math.max(startRow, currentRow);
                        const minCol = Math.min(startCol, currentCol);
                        const maxCol = Math.max(startCol, currentCol);

                        // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                        selectedCells.clear();
                        for (let i = minRow; i <= maxRow; i++) {
                            for (let j = minCol; j <= maxCol; j++) {
                                const selectedCell = rows[i].children[j];
                                if (selectedCell.tagName === 'TD') {
                                    selectedCell.classList.add('selected');
                                    if (i === currentRow && j === currentCol) {
                                        selectedCell.focus();
                                    }
                                }
                                selectedCells.add(selectedCell);
                            }
                        }
                    }
                });

                // Ê∑ªÂä†Â§±ÂéªÁÑ¶ÁÇπ‰∫ã‰ª∂ÁõëÂê¨
                cell.addEventListener('blur', (e) => {
                    if (!selectedCells.has(cell)) {
                        cell.classList.remove('selected');
                    }
                });
            });
        }

        // ÊèíÂÖ•Ë°å
        function insertRow(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º‰ΩçÁΩÆ
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑË°åÁ¥¢ÂºïÔºàÈúÄË¶ÅÂáèÂéª1Êù•Ë∞ÉÊï¥Ë°®Â§¥ÁöÑÂΩ±ÂìçÔºâ
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    selectedRows.add(cell.parentElement.rowIndex - 1);
                }
            });

            if (selectedRows.size === 0) return;

            const newRow = document.createElement('tr');
            const colCount = rows[0].children.length;
            
            for (let i = 0; i < colCount; i++) {
                const td = document.createElement('td');
                td.contentEditable = true;
                newRow.appendChild(td);
            }

            // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();

            if (direction === 'up') {
                const minRow = Math.min(...selectedRows);
                tbody.insertBefore(newRow, tbody.children[minRow]);
            } else {
                const maxRow = Math.max(...selectedRows);
                tbody.insertBefore(newRow, tbody.children[maxRow + 1]);
            }

            // Â∞ÜÁÑ¶ÁÇπÁßªÂä®Âà∞Êñ∞ÊèíÂÖ•Ë°åÁöÑÂØπÂ∫îÂàó‰ΩçÁΩÆ
            if (selectedCellIndices.length > 0) {
                const { colIndex } = selectedCellIndices[0];
                const targetCell = newRow.children[colIndex];
                if (targetCell) {
                    targetCell.classList.add('selected');
                    selectedCells.add(targetCell);
                    targetCell.focus();
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // ÊèíÂÖ•Âàó
        function insertColumn(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º‰ΩçÁΩÆ
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });
            
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            const colCount = rows[0].children.length;
            const newColIndex = direction === 'left' ? Math.min(...selectedCols) : Math.max(...selectedCols) + 1;

            // Ê∏ÖÈô§ÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();

            // ÊèíÂÖ•Ë°®Â§¥
            const newHeader = document.createElement('th');
            newHeader.contentEditable = true;
            newHeader.textContent = `Âàó${colCount + 1}`;
            rows[0].insertBefore(newHeader, rows[0].children[newColIndex]);

            // ÊèíÂÖ•Êï∞ÊçÆÂçïÂÖÉÊ†º
            for (let i = 1; i < rows.length; i++) {
                const newCell = document.createElement('td');
                newCell.contentEditable = true;
                rows[i].insertBefore(newCell, rows[i].children[newColIndex]);
            }

            // Â∞ÜÁÑ¶ÁÇπÁßªÂä®Âà∞Êñ∞ÊèíÂÖ•ÂàóÁöÑÂØπÂ∫îË°å‰ΩçÁΩÆ
            if (selectedCellIndices.length > 0) {
                const { rowIndex } = selectedCellIndices[0];
                const targetCell = rows[rowIndex].children[newColIndex];
                if (targetCell) {
                    targetCell.classList.add('selected');
                    selectedCells.add(targetCell);
                    targetCell.focus();
                }
            }

            // Êõ¥Êñ∞Ë°®Ê†ºÁõëÂê¨Âô®Âíå‰∏ªÈ¢ò
            updateTableListeners();
            updateTheme();

            // Á°Æ‰øùÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑËæπÊ°ÜÁä∂ÊÄÅÊ≠£Á°Æ
            document.querySelectorAll('td, th').forEach(cell => {
                if (!selectedCells.has(cell)) {
                    cell.classList.remove('selected');
                }
            });
        }

        // Âà†Èô§ÈÄâ‰∏≠ÁöÑË°å
        function deleteSelectedRows() {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º‰ΩçÁΩÆ
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑË°åÁ¥¢ÂºïÔºàÈúÄË¶ÅÂáèÂéª1Êù•Ë∞ÉÊï¥Ë°®Â§¥ÁöÑÂΩ±ÂìçÔºâ
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    selectedRows.add(cell.parentElement.rowIndex - 1);
                }
            });

            if (selectedRows.size === 0) return;

            // ‰ªéÂêéÂêëÂâçÂà†Èô§ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
            const rowsToDelete = Array.from(selectedRows).sort((a, b) => b - a);
            rowsToDelete.forEach(rowIndex => {
                const row = rows[rowIndex];
                if (row) {
                    tbody.removeChild(row);
                }
            });

            // ÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
            if (selectedCellIndices.length > 0) {
                const { colIndex } = selectedCellIndices[0];
                const targetRowIndex = Math.min(rowsToDelete[0], rows.length - 1);
                const targetRow = rows[targetRowIndex];
                if (targetRow) {
                    const targetCell = targetRow.cells[colIndex];
                    if (targetCell) {
                        targetCell.classList.add('selected');
                        selectedCells.add(targetCell);
                        targetCell.focus();
                    }
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂàó
        function deleteSelectedColumns() {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º‰ΩçÁΩÆ
            const selectedCellIndices = Array.from(selectedCells).map(cell => {
                const row = cell.parentElement;
                const rowIndex = row.rowIndex;
                const colIndex = Array.from(row.children).indexOf(cell);
                return { rowIndex, colIndex };
            });
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂàóÁ¥¢Âºï
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            if (selectedCols.size === 0) return;

            // ‰ªéÂêéÂêëÂâçÂà†Èô§ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
            const colsToDelete = Array.from(selectedCols).sort((a, b) => b - a);
            colsToDelete.forEach(colIndex => {
                for (let i = rows.length - 1; i >= 0; i--) {
                    const row = rows[i];
                    const cell = row.cells[colIndex];
                    if (cell) {
                        row.removeChild(cell);
                    }
                }
            });

            // ÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
            if (selectedCellIndices.length > 0) {
                const { rowIndex, colIndex } = selectedCellIndices[0];
                const targetRow = rows[rowIndex];
                if (targetRow) {
                    // ËÆ°ÁÆóÊñ∞ÁöÑÂàóÁ¥¢Âºï
                    let newColIndex = colIndex;
                    // ËÆ°ÁÆóË¢´Âà†Èô§ÁöÑÂàóÊï∞
                    const deletedColsBefore = colsToDelete.filter(col => col < colIndex).length;
                    newColIndex -= deletedColsBefore;
                    
                    // Â¶ÇÊûúÁõÆÊ†áÂàó‰∏çÂ≠òÂú®ÔºåÂàôÈÄâÊã©Ââç‰∏ÄÂàó
                    if (newColIndex >= targetRow.cells.length) {
                        newColIndex = targetRow.cells.length - 1;
                    }

                    const targetCell = targetRow.cells[newColIndex];
                    if (targetCell) {
                        // Á°Æ‰øùÂçïÂÖÉÊ†ºÂèØÁºñËæë
                        targetCell.setAttribute('contenteditable', 'true');
                        // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                        selectedCells.clear();
                        // Ê∑ªÂä†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                        targetCell.classList.add('selected');
                        selectedCells.add(targetCell);
                        targetCell.focus();
                    }
                }
            }

            // Êõ¥Êñ∞Ë°®Ê†ºÁõëÂê¨Âô®Âíå‰∏ªÈ¢ò
            updateTableListeners();
            updateTheme();

            // Á°Æ‰øùÊâÄÊúâÂçïÂÖÉÊ†ºÁöÑËæπÊ°ÜÁä∂ÊÄÅÊ≠£Á°Æ
            document.querySelectorAll('td, th').forEach(cell => {
                if (!selectedCells.has(cell)) {
                    cell.classList.remove('selected');
                }
            });
        }

        // ‰øùÂ≠òË°®Ê†º
        function saveTable() {
            const table = document.getElementById('mainTable');
            const tableClone = table.cloneNode(true);
            
            // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÈ¢úËâ≤
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim();
            const themeRowColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-row-color').trim();
            
            // ËÆæÁΩÆË°®Ê†ºÊ†∑Âºè
            tableClone.style.borderCollapse = 'collapse';
            tableClone.style.width = '100%';
            tableClone.style.margin = '0';
            
            // ËÆæÁΩÆË°®Â§¥Ê†∑Âºè
            const thead = tableClone.querySelector('thead');
            thead.style.position = 'sticky';
            thead.style.top = '0';
            thead.style.zIndex = '1';
            thead.style.backgroundColor = 'white';
            
            // ËÆæÁΩÆË°®Â§¥ÂçïÂÖÉÊ†ºÊ†∑Âºè
            const headerCells = tableClone.querySelectorAll('th');
            headerCells.forEach(cell => {
                cell.style.backgroundColor = themeColor;
                cell.style.color = 'white';
                cell.style.padding = '12px';
                cell.style.textAlign = 'left';
                cell.style.border = '1px solid #ddd';
                cell.style.fontWeight = 'bold';
                cell.style.position = 'sticky';
                cell.style.top = '0';
                cell.style.zIndex = '2';
                cell.style.height = '32px';
                cell.style.lineHeight = '20px';
            });
            
            // ËÆæÁΩÆÊï∞ÊçÆÂçïÂÖÉÊ†ºÊ†∑Âºè
            const dataCells = tableClone.querySelectorAll('td');
            dataCells.forEach(cell => {
                cell.style.padding = '4px 8px';
                cell.style.border = '1px solid #ddd';
                cell.style.height = '32px';
                cell.style.lineHeight = '20px';
            });
            
            // ËÆæÁΩÆË°åÊ†∑Âºè
            const rows = tableClone.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (index > 0) { // Ë∑≥ËøáË°®Â§¥Ë°å
                    row.style.backgroundColor = index % 2 === 0 ? 'white' : themeRowColor;
                }
            });
            
            // ÁßªÈô§ÊâÄÊúâÁ±ªÂêçÂíåÊåáÂÆöÁöÑÂ±ûÊÄß
            tableClone.querySelectorAll('*').forEach(element => {
                element.removeAttribute('class');
                element.removeAttribute('contenteditable');
                element.style.removeProperty('min-width');
                element.style.removeProperty('font-size');
                element.style.removeProperty('vertical-align');
                element.style.removeProperty('white-space');
                element.style.removeProperty('position');
                element.style.removeProperty('box-sizing');
            });
            
            // ‰øùÂ≠òÂà∞table.txt
            const tableHtml = tableClone.outerHTML.replace(/\s+/g, ' ').trim();
            const blob = new Blob([tableHtml], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ‰ªéÊñáÊú¨ËΩΩÂÖ•Ë°®Ê†º
        function loadTableFromText() {
            const content = document.getElementById('tableContent').value;
            if (!content) return;

            const table = document.getElementById('mainTable');
            table.innerHTML = content;
            updateTableListeners();
            updateTheme();
        }

        // ÁßªÂä®Ë°å
        function moveRow(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑË°å
            const selectedRows = new Set();
            selectedCells.forEach(cell => {
                if (cell.tagName === 'TD') {
                    selectedRows.add(cell.parentElement);
                }
            });

            if (selectedRows.size === 0) return;

            const rowsToMove = Array.from(selectedRows);
            if (direction === 'up') {
                // ‰ªé‰∏ãÂæÄ‰∏äÁßªÂä®ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
                for (let i = 0; i < rowsToMove.length; i++) {
                    const row = rowsToMove[i];
                    const prevRow = row.previousElementSibling;
                    if (prevRow && prevRow.tagName === 'TR') {
                        tbody.insertBefore(row, prevRow);
                    }
                }
            } else {
                // ‰ªé‰∏äÂæÄ‰∏ãÁßªÂä®ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
                for (let i = rowsToMove.length - 1; i >= 0; i--) {
                    const row = rowsToMove[i];
                    const nextRow = row.nextElementSibling;
                    if (nextRow && nextRow.tagName === 'TR') {
                        tbody.insertBefore(row, nextRow.nextElementSibling);
                    }
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // ÁßªÂä®Âàó
        function moveColumn(direction) {
            if (selectedCells.size === 0) return;
            
            saveTableState();
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂàóÁ¥¢Âºï
            const selectedCols = new Set();
            selectedCells.forEach(cell => {
                selectedCols.add(Array.from(cell.parentElement.children).indexOf(cell));
            });

            if (selectedCols.size === 0) return;

            const colsToMove = Array.from(selectedCols);
            if (direction === 'left') {
                // ‰ªéÂè≥ÂæÄÂ∑¶ÁßªÂä®ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
                for (let i = 0; i < colsToMove.length; i++) {
                    const colIndex = colsToMove[i];
                    if (colIndex > 0) {
                        for (let row of rows) {
                            const cell = row.children[colIndex];
                            row.insertBefore(cell, row.children[colIndex - 1]);
                        }
                    }
                }
            } else {
                // ‰ªéÂ∑¶ÂæÄÂè≥ÁßªÂä®ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñ
                for (let i = colsToMove.length - 1; i >= 0; i--) {
                    const colIndex = colsToMove[i];
                    if (colIndex < rows[0].children.length - 1) {
                        for (let row of rows) {
                            const cell = row.children[colIndex];
                            row.insertBefore(cell, row.children[colIndex + 2]);
                        }
                    }
                }
            }

            updateTableListeners();
            updateTheme();
        }

        // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÁõëÂê¨
        document.addEventListener('keydown', (e) => {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
            if (selectedCells.size === 0) return;

            // Âà†Èô§Ë°å/ÂàóÁöÑÂø´Êç∑ÈîÆÔºàÁßªÂà∞ÊúÄÂâçÈù¢Ôºâ
            if (e.key === 'Delete') {
                e.preventDefault();
                if (e.shiftKey) {
                    deleteSelectedRows();
                } else {
                    deleteSelectedColumns();
                }
                return;
            }

            // ÂèñÊ∂àÁºñËæëÁöÑÂø´Êç∑ÈîÆ
            if (e.key === 'Escape') {
                e.preventDefault();
                // ÁßªÈô§ÁºñËæëÁä∂ÊÄÅ‰ΩÜ‰øùÁïôÁÑ¶ÁÇπÂíåÈÄâ‰∏≠Áä∂ÊÄÅ
                const activeElement = document.activeElement;
                if (activeElement && activeElement.matches('td, th')) {
                    // ‰øùÂ≠òÂΩìÂâçÂÜÖÂÆπ
                    const content = activeElement.innerHTML;
                    // ÁßªÈô§ contenteditable Â±ûÊÄß
                    activeElement.removeAttribute('contenteditable');
                    // ÈáçÊñ∞ËÆæÁΩÆÂÜÖÂÆπ
                    activeElement.innerHTML = content;
                    // ÈáçÊñ∞Ê∑ªÂä† contenteditable Â±ûÊÄß
                    activeElement.setAttribute('contenteditable', 'true');
                    // ÁßªÈô§ÁÑ¶ÁÇπ
                    activeElement.blur();
                    // ÈáçÊñ∞Ëé∑ÂæóÁÑ¶ÁÇπ
                    setTimeout(() => {
                        activeElement.focus();
                        // Â∞ÜÂÖâÊ†áÁßªÂä®Âà∞ÂÜÖÂÆπÊú´Â∞æ
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(activeElement);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }, 0);
                }
                return;
            }

            // ÊñπÂêëÈîÆÁßªÂä®ÂçïÂÖÉÊ†º
            if (!e.ctrlKey && !e.altKey) {
                switch (e.key) {
                    case 'ArrowUp':
                    case 'ArrowDown':
                    case 'ArrowLeft':
                    case 'ArrowRight':
                        if (!e.shiftKey) {
                            e.preventDefault();
                            moveCellFocus(e.key);
                            return;
                        }
                        break;
                    case 'Tab':
                        e.preventDefault();
                        // Â¶ÇÊûúÊåâ‰Ωè ShiftÔºåÂàôÂêëÂ∑¶ÁßªÂä®ÔºåÂê¶ÂàôÂêëÂè≥ÁßªÂä®
                        const direction = e.shiftKey ? 'ArrowLeft' : 'ArrowRight';
                        const currentCell = document.activeElement;
                        if (!currentCell || !currentCell.matches('td, th')) return;

                        const currentRow = currentCell.parentElement;
                        const currentRowIndex = currentRow.rowIndex;
                        const currentColIndex = Array.from(currentRow.children).indexOf(currentCell);
                        const table = document.getElementById('mainTable');
                        const rows = table.getElementsByTagName('tr');
                        
                        if (e.shiftKey && currentColIndex === 0) {
                            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂàóÔºåË∑≥ËΩ¨Âà∞‰∏ä‰∏ÄË°åÁöÑÊúÄÂêé‰∏ÄÂàó
                            if (currentRowIndex > 0) {
                                const prevRow = rows[currentRowIndex - 1];
                                const lastCell = prevRow.children[prevRow.children.length - 1];
                                selectAndFocusCell(lastCell);
                            }
                        } else if (!e.shiftKey && currentColIndex === currentRow.children.length - 1) {
                            // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂàóÔºåË∑≥ËΩ¨Âà∞‰∏ã‰∏ÄË°åÁöÑÁ¨¨‰∏ÄÂàó
                            if (currentRowIndex < rows.length - 1) {
                                const nextRow = rows[currentRowIndex + 1];
                                const firstCell = nextRow.children[0];
                                selectAndFocusCell(firstCell);
                            }
                        } else {
                            // Ê≠£Â∏∏ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™/‰∏ä‰∏Ä‰∏™ÂçïÂÖÉÊ†º
                            moveCellFocus(direction);
                        }
                        return;
                }
            }

            // ÊèíÂÖ•Ë°å/ÂàóÁöÑÂø´Êç∑ÈîÆ
            if (e.shiftKey) {
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        insertRow('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        insertRow('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        insertColumn('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        insertColumn('right');
                        break;
                }
            }
            // ÁßªÂä®Ë°å/ÂàóÁöÑÂø´Êç∑ÈîÆ
            else if (e.altKey) {
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        moveRow('up');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        moveRow('down');
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        moveColumn('left');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        moveColumn('right');
                        break;
                }
            }
            // Êí§ÈîÄ„ÄÅËøòÂéü„ÄÅ‰øùÂ≠òÁöÑÂø´Êç∑ÈîÆ
            else if (e.ctrlKey) {
                switch (e.key.toLowerCase()) {
                    case 'z':
                        if (!e.shiftKey) {
                            e.preventDefault();
                            undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 's':
                        e.preventDefault();
                        saveTable();
                        break;
                }
            }
        });

        // ÁßªÂä®ÂçïÂÖÉÊ†ºÁÑ¶ÁÇπ
        function moveCellFocus(direction) {
            const table = document.getElementById('mainTable');
            const rows = table.getElementsByTagName('tr');
            const currentCell = document.activeElement;
            
            if (!currentCell || !currentCell.matches('td, th')) return;

            const currentRow = currentCell.parentElement;
            const currentRowIndex = currentRow.rowIndex;
            const currentColIndex = Array.from(currentRow.children).indexOf(currentCell);
            
            let targetRow, targetCol;
            
            switch (direction) {
                case 'ArrowUp':
                    targetRow = rows[currentRowIndex - 1];
                    targetCol = currentColIndex;
                    break;
                case 'ArrowDown':
                    targetRow = rows[currentRowIndex + 1];
                    targetCol = currentColIndex;
                    break;
                case 'ArrowLeft':
                    targetRow = currentRow;
                    targetCol = currentColIndex - 1;
                    break;
                case 'ArrowRight':
                    targetRow = currentRow;
                    targetCol = currentColIndex + 1;
                    break;
            }

            if (targetRow && targetRow.children[targetCol]) {
                const targetCell = targetRow.children[targetCol];
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCells.clear();
                // ÈÄâ‰∏≠Âπ∂ËÅöÁÑ¶ÁõÆÊ†áÂçïÂÖÉÊ†º
                targetCell.classList.add('selected');
                selectedCells.add(targetCell);
                targetCell.focus();
            }
        }

        // ÈÄâ‰∏≠Âπ∂ËÅöÁÑ¶ÂçïÂÖÉÊ†ºÁöÑËæÖÂä©ÂáΩÊï∞
        function selectAndFocusCell(cell) {
            // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            selectedCells.clear();
            // ÈÄâ‰∏≠Âπ∂ËÅöÁÑ¶ÁõÆÊ†áÂçïÂÖÉÊ†º
            cell.classList.add('selected');
            selectedCells.add(cell);
            cell.focus();
        }

        // ÂàùÂßãÂåñË°®Ê†ºÁõëÂê¨Âô®
        updateTableListeners();
    </script>
</body>
</html> 